<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ target_user.username }}'s Profile - Mathforces</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; color: #334155; }
        .navbar { background-color: #0f172a !important; padding: 0.8rem 0; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .rating-number { font-size: 1.5rem; font-weight: bold; }
        .rank-title { font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
        .btn-friend { border-radius: 20px; padding: 5px 20px; transition: 0.3s; font-weight: 600; }
        .stat-link { text-decoration: none; color: inherit; transition: 0.2s; }
        .stat-link:hover { opacity: 0.7; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark mb-4 shadow">
        <div class="container">
            <a class="navbar-brand" href="{% url 'problem_list' %}"><b>MATHFORCES</b></a>
            <div class="collapse navbar-collapse">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="{% url 'problem_list' %}">Archive</a>
                    <a class="nav-link" href="{% url 'contest_list' %}">Contests</a>
                    <a class="nav-link" href="{% url 'submission_list' %}">Submissions</a>
                    <a class="nav-link" href="{% url 'ranking' %}">Ranking</a>
                    <a class="nav-link active" href="{% url 'profile_view' %}">My Profile</a>
                </div>
                <form class="d-flex ms-3" action="{% url 'user_search' %}" method="GET">
                    <input class="form-control form-control-sm me-2" type="search" name="q" placeholder="Search users">
                    <button class="btn btn-outline-light btn-sm" type="submit">Search</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="card p-4 text-center mb-4">
                    <div class="mb-3">
                        <div class="bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center shadow-sm" style="width: 80px; height: 80px; font-size: 2rem; font-weight: 700;">
                            {{ target_user.username|first|upper }}
                        </div>
                    </div>
                    
                    <h4 class="mb-1 fw-bold">{{ target_user.username }}</h4>
                    
                    <div class="mb-2">
                        {% if rank %}
                            <span class="rank-title fw-bold" style="color: {{ rank.color_code }};">{{ rank.title }}</span>
                        {% else %}
                            <span class="text-muted small fw-bold">NEWBIE</span>
                        {% endif %}
                    </div>

                    {% if request.user.is_authenticated and request.user != target_user %}
                        <form action="{% url 'toggle_friend' target_user.username %}" method="POST" class="mb-3">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm {% if is_friend %}btn-outline-danger{% else %}btn-primary{% endif %} btn-friend w-100">
                                {% if is_friend %}Remove Friend{% else %}Add Friend{% endif %}
                            </button>
                        </form>
                    {% endif %}

                    <div class="mb-3">
                        {% if profile.is_disqualified %}
                            <span class="badge bg-danger">DISQUALIFIED</span>
                        {% else %}
                            <span class="badge bg-success">ACTIVE</span>
                        {% endif %}
                    </div>
                    
                    <hr>

                    <div class="row text-center">
                        <div class="col">
                            <div class="rating-number text-primary">{{ profile.rating }}</div>
                            <small class="text-muted text-uppercase" style="font-size: 0.65rem; font-weight: 700;">Rating</small>
                        </div>
                        <div class="col border-start border-end">
                            <div class="rating-number">{{ solved_count }}</div>
                            <small class="text-muted text-uppercase" style="font-size: 0.65rem; font-weight: 700;">Solved</small>
                        </div>
                        <div class="col">
                            <a href="{% url 'friends_list' %}" class="stat-link">
                                <div class="rating-number text-success">{{ target_user.profile.friends.count }}</div>
                                <small class="text-muted text-uppercase" style="font-size: 0.65rem; font-weight: 700;">Friends</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card p-4 mb-4">
                    <h5 class="fw-bold mb-3">Rating History</h5>
                    <div style="height: 300px;">
                        <canvas id="ratingChart"></canvas>
                    </div>
                </div>

                <div class="card p-4">
                    <h5 class="fw-bold mb-4">Recent Submissions</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Problem</th>
                                    <th class="text-center">Result</th>
                                    <th class="text-end">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sub in submissions %}
                                <tr>
                                    <td><a href="{% url 'problem_detail' sub.problem.id %}" class="text-decoration-none text-dark fw-medium">{{ sub.problem.title }}</a></td>
                                    <td class="text-center">
                                        <a href="{% url 'submission_detail' sub.id %}" class="text-decoration-none">
                                            {% if sub.is_correct %}
                                                <span class="badge bg-success">OK</span>
                                            {% else %}
                                                <span class="badge bg-danger">WA</span>
                                            {% endif %}
                                        </a>
                                    </td>
                                    <td class="text-muted small text-end">{{ sub.submitted_at|date:"M d, H:i" }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="3" class="text-center py-4 text-muted">No submissions yet</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ДАННЫЕ СТРОГО ИЗ RATING HISTORY
        const ratingLabels = [
            {% for entry in target_user.ratinghistory_set.all %}
                "{{ entry.contest.title|truncatechars:10 }}",
            {% endfor %}
        ];
        
        const ratingData = [
            {% for entry in target_user.ratinghistory_set.all %}
                {{ entry.rating }},
            {% endfor %}
        ];

        const ctx = document.getElementById('ratingChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ratingLabels.length ? ratingLabels : ["Start"],
                datasets: [{
                    label: 'Rating Evolution',
                    data: ratingData.length ? ratingData : [{{ profile.rating }}],
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#0d6efd',
                    pointRadius: 5,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    y: { 
                        beginAtZero: false, 
                        grid: { color: '#f0f0f0' },
                        ticks: { font: { weight: 'bold' } }
                    },
                    x: { grid: { display: false } }
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: { backgroundColor: '#0f172a' }
                }
            }
        });
    </script>
</body>
</html>